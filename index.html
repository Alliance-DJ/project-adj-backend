<!DOCTYPE html>
<html>

<head></head>

<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>

  <canvas id='grid' width="800" height="800"></canvas>
  <button id='tempBtn'>join</button>


  <script>
    const socket = io('ws://localhost:4001')

    const canvas = document.getElementById('grid')
    const ctx = canvas.getContext('2d')

    const btn = document.getElementById('tempBtn')

    function drawLine() {
      ctx.beginPath()

      ctx.moveTo(0, 0)
      ctx.lineTo(0, 800)

      ctx.moveTo(0, 0)
      ctx.lineTo(800, 0)

      ctx.stroke()
    }

    function drawBall(ball) {
      ctx.beginPath();
      ctx.arc(ball.posX, ball.posY - 30, 20, 0, Math.PI * 2);
      ctx.fillStyle = "#0095DD";
      ctx.fill();
      ctx.closePath();
    }

    drawLine()




    btn.addEventListener('click', () => {
      socket.emit('join', {})
    })

    let stateNum = 0
    socket.on('stateUpdate', (data) => {
      // state number validating
      if(data.stateNum < stateNum) {
         return
      }

      // data has my socket
      const idx = _.indexOf(Object.keys(data), socket.id)
      if (idx < 0) {
         return
      }
      
      ctx.clearRect(0, 0, 800, 800);
      drawLine()
      drawBall(data[socket.id])

      stateNum = data.stateNum
    })
  </script>
</body>

</html>